---
title: "Пингвин-фотолюбитель: 5. Стекинг"
category: [ photo, processing, penguin, tech, soft, graphics ]
tags:
  - стекинг
  - align_image_stack
  - enfuse
  - HDR
  - Hugin
  - ISO
  - Linux

description: Приемы стекинга фотографий под Linux с использованием пакета enfuse
image: /assets/img/2016-06/p-05/stacking.jpg
recommend: true
---
{% include image.liquid place="right" width=320 src="/assets/img/2016-06/p-05/stacking.jpg"
  link="https://commons.wikimedia.org/wiki/File:%D0%A7%D0%B5%D1%88%D1%83%D0%B9%D0%BA%D0%B8_%D0%BA%D1%80%D1%8B%D0%BB%D0%B0_%D0%B1%D0%B0%D0%B1%D0%BE%D1%87%D0%BA%D0%B8.jpg"
  title="Чешуйки крыла бабочки" caption="Картинка взята с [WikiMedia Commons](https://commons.wikimedia.org/wiki/File:%D0%A7%D0%B5%D1%88%D1%83%D0%B9%D0%BA%D0%B8_%D0%BA%D1%80%D1%8B%D0%BB%D0%B0_%D0%B1%D0%B0%D0%B1%D0%BE%D1%87%D0%BA%D0%B8.jpg)" %}

Первым делом, пожалуй, сошлюсь на источники: ключевым по теме данного поста стал англоязычный пост
[Barry Gruss&shy;ling — **«Focus Stacking in Linux»**][barry]; прочая информация получена из официального
руководства **[enblend/enfuse][enblend]**. Соб&shy;с&shy;т&shy;вен&shy;но enfuse и будет нашим главным
инструментом для стекинга.

Что такое стекинг? Это когда мы делаем несколько кадров одного и того же, в общем случае — с разными
параметрами, а затем хитрый алгоритм собирает нам результирующую картинку. Например, если мы сделаем
несколько снимков с разной экспозицией, то можем получить в результате что-то очень похожее на результат
сведения [HDR, о котором я говорил в предыдущем посте][hdr]. С той лишь разницей, что собственно
HDR-изображения (т.е. с динамическим диапазоном более 8 бит на канал) мы не получим, сразу приведение
к 8-бит­но­му виду.

Кроме стекинга по экспозиции рассмотрим еще уменьшение шумов и стекинг по фокусу.

<!--more-->

Но начнем с **экпозиционного**. Для примера возьмем те же три снимка, с которыми мы уже имели дело
[в прошлом посте][hdr]. И проделаем над ними следующие операции (в командной строке):

{% highlight console %}
$ align_image_stack -a aligned_ IMG_*
{% endhighlight %}

Это, как нетрудно заметить, выравнивание. Кстати, **[Luminance HDR][luminance]** тоже это делает, причем
с использованием той же утилиты, которая входит в состав пакета **[Hugin][hugin]**. Я использовал здесь
только самые необходимые параметры, поскольку пока нам этого достаточно.

И сводим выровненные кадры:

{% highlight console %}
$ enfuse -o result.tif aligned_*
{% endhighlight %}

Опять же, оставляем все параметры по умолчанию, указав только исходные файлы и конечный... Получаем примерно такое:

{% include image.liquid place="center" width=800 src="/assets/img/2016-06/p-05/result.jpg" %}

А если хочется добавить «драмы», можем чуть усложнить вызов:

{% highlight console %}
$ enfuse -o result.tif --hard-mask aligned_*
{% endhighlight %}

И получить:

{% include image.liquid place="center" width=800 src="/assets/img/2016-06/p-05/result-hard.jpg" %}

Следующая замечательная вещь, которую мы можем сделать посредством стекинга, это **уменьшение шумов
*без потери детализации***. Для этого нужно снять на высоких ISO серию снимков. Несмотря на то, что
в данном случае мы не меняем настройки между снимками, снимки все-таки должны быть разными — нельзя
просто взять и скопировать один в нескольких экземплярах, поскольку на них шум будет в одних и тех же точках.

Я отснял четыре кадра на ISO 3200, а затем применил к ним те же самые команды, что и выше для стекинга
экспозиции. Давайте посмотрим 100% кроп — было:

{% include image.liquid place="center" width=640 src="/assets/img/2016-06/p-05/3200.jpg" %}

Стало:

{% include image.liquid place="center" width=640 src="/assets/img/2016-06/p-05/denoise.jpg" %}

Для сравнения — кроп с кадра, снятого на ISO 1600:

{% include image.liquid place="center" width=640 src="/assets/img/2016-06/p-05/1600.jpg" %}

К сожалению, я тогда не догадался снять тот же кадр на ISO 800, что должно соответствовать сборке
из четырех 3200-х, а переснимать всю серию мне лень.

Переходим к самому сложному: к **стекингу по фокусу**... Тут нас ждет несколько проблем: во-первых, изменение фокуса,
в отличие от других параметров, меняет контуры снятых объектов, что затрудняет выравнивание, во-вторых, желание
максимальной резкости потребует уже неумолчательных параметров при сведении. И, кстати, для этого примера я был
вынужден снимать уже со штатива (все предыдущие были спокойно сняты с рук), отчасти это связано с проблемой контуров,
отчасти с тем, что для наглядности съемка делалась с минимальной дистанции, приближено к условиям предметной съемки,
для которой стекинг по фокусу обычно и применяется.

Итак, я сделал семь снимков, со штатива, с ручным фокусом. Покажу первый, четвертый и седьмой:

<div class="image-box">
{% include image.liquid place="inner" width=240 src="/assets/img/2016-06/p-05/f1.jpg" %}
{% include image.liquid place="inner" width=240 src="/assets/img/2016-06/p-05/f2.jpg" %}
{% include image.liquid place="inner" width=240 src="/assets/img/2016-06/p-05/f3.jpg" %}
</div>

Выравнивание делается так:

{% highlight console %}
$ align_image_stack -a aligned_ -m -g 10 -C IMG_*
{% endhighlight %}

Описание параметров можно прочитать [здесь][params]. Вкратце: `-m` позволяет выравнивать контуры разного размера
в кадре (а они при разной фокусировке разные), `-C` выполняет обрезку (crop), а `-g 10` задает локальный поиск
и размер поля для этого поиска.

Для сведения же выполняем такую команду:

{% highlight console %}
$ enfuse -o result.tif \
    --exposure-weight=0 --saturation-weight=0 --contrast-weight=1 --hard-mask \
    aligned_*
{% endhighlight %}

Нам нужны сфокусированные, т.е. наиболее контрастные участки, тогда как все остальное нам не интересно,
пусть программа на него не отвлекается. Ну и `--hard-mask`, чтобы не накладывать размытое на четкое. Получаем:

{% include image.liquid place="center" width=800 src="/assets/img/2016-06/p-05/f-result.jpg" %}

Неидеально, но вся страница читается. Для получения более высокого качества нужно еще больше шагов, да и снимать
не на открытой диафрагме, как в демонстрационном примере...

В целом, стекинг — очень интересная технология, позволяющая обойти различные ограничения, например, на динамический
диапазон, ISO или ГРИП, как показано выше. Единственное, что сильно сужает область применения — объект съемки должен
быть неподвижен — выравнивание может компенсировать небольшие смещения рук, но вот с движением в кадре сделать
ничего не получится.


[barry]: http://www.barrygrussling.com/?p=127
[enblend]: http://enblend.sourceforge.net/
[hdr]: {% link _posts/photo/2016/2016-06-18-hdr.md %}
[luminance]: http://qtpfsgui.sourceforge.net/
[hugin]: http://hugin.sourceforge.net/
[params]: http://wiki.panotools.org/Align_image_stack
