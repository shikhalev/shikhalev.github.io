---
title: Отчет о рефакторинге
description: Как я рефакторил сайт, с чем столкнулся и о чем узнал
category:
  - tech
  - web
  - programming
  - about
image: /assets/img/2021-07/report/jekyll-screen.png
tags:
  - shikhalev.org
  - сайты
  - блоги
  - верстка
  - Jekyll
  - статическая генерация
  - HTML
  - CSS
  - JavaScript
  - грабли
  - markdown
  - SASS
  - SCSS
  - kramdown
  - Liquid
---
{% include image.liquid place="right" width=320 src="/assets/img/2021-07/report/jekyll-screen.png"
   caption="Скриншот с [официального сайта Jekyll](https://jekyllrb.com/)" %}

Итак, я таки отрефакторил и обновил данный сайт. Почему нельзя было сразу делать правильно? Ну, в основном потому,
что я впервые имел дело с Jekyll, изрядно подзабыл (а что-то и не знал) базовые приемы верстки... И так далее,
и тому подобное.

Вторая (в моем случае) причина — это то, что, как это часто бывает, представление о желаемом результате уточнялось
и формировалось в процессе достижения результата просто работающего. Соответственно, решение «исторически сложилось»,
если вы понимаете, о чем я. Любой проект ставит разработчика перед выбором: или бесконечное (и потому бесплодное)
делание «как надо», или движение к идеалу через неидеальные, зато рабочие, варианты, которые, впрочем, без регулярного
рефакторинга быстро становятся неулучшаемым и иногда не совсем рабочим болотом.

Но на самом деле этот пост не только, и не столько о рефакторинге как таковом, сколько о технической стороне этого
сайта в целом. Благо, сразу после выкатки первого варианта я так технический пост и не написал, желая сначала получше
разобраться. Вот, сейчас и пишу о том, с чем разобрался, и о процессе этого разбирательства.

<!--more-->

## Вводные

Сайт сделан на статическом генераторе **[Jekyll][jekyll]{:.img-icon-jekyll}** и размещен на **[GitHub Pages][pages]{:.img-icon-github}**,
чтобы не платить за хостинг. Комментарии — **[Staticman][staticman]{:.img-icon-staticman}**, размещенный на **[Heroku][heroku]{:.img-icon-heroku}**
также бесплатно. Собственно, бесплатность была для меня необходимым критерием при выборе технологии, поскольку блогом я не зарабатываю.

{:.note.italic}
За все время существования [технобложика][bs], гуглореклама, крутящаяся там, не докрутилась до минимально выводимой суммы, даже
не приблизилась. Поэтому сейчас при рефакторинге я ее и убрал совсем (хотя в скрытых элементах верстки и оставил — место под нее,
но не ее саму — и если вдруг посещаемость взлетит на несколько порядков, могу вернуть). [Блок-по­про­шай­ка](#donate) сработал пока
1 (один) раз за все время. Что приятно, но тоже не позволяет говорить о профите или окупаемости.

Почему не [ЖЖ][livejournal], [Blogger][blogger], [Wordpress][wordpress] и так далее?

: Несколько факторов:

  *Возможности контроля верстки* — я хочу, чтоб мои посты выглядели так, как я хочу. В ЖЖ (и [DW][dreamwidth]) эти возможности
  вообще крайне скудны. В Blogger и Wordpress они достаточно богаты, но требуют серьезных усилий, чтобы навесить свое оформление
  поверх сложных механизмов движка.

  Более того, мне нужно одновременно иметь контроль над версткой и возможность о ней не задумываться при написании текстов,
  то есть разметку типа [Markdown][markdown] и автоматическую систему раскраски исходного кода. И еще что-нибудь вроде макросов
  для тех случаев, когда маркдауна не достаточно.

  *Возможность легкого и быстрого «перезда»* на случай, если мои тексты вступят в конфликт с политикой хостера, или его самого
  заблокируют. Увы, в последнее время угроза бана на любом сервисе вполне реальна, для этого не требуется нарушать законы,
  достаточно стука со стороны «прогрессивной общественности». Ну, а российские блокировки и вовсе лупят по площадям, как в копеечку...

  И хотя упомянутые сервисы и позволяют делать какие-то архивы и бэкапы, развернуть их где-то еще не получится. Исключение — Wordpress,
  который можно поднять и на своем сервере, но учитывая его сложность и системные требования, быстрым и легким такой переезд
  точно не назовешь.

  В общем, *вендор-лок* и сложность/невозможность *существенной* кастомизации делают готовые блог-платформы для меня не лучшим выбором.

Почему не свой сервер с самописным бэкендом на рельсах или другом фреймворке?

: Тут просто — *цена*. Причем, кроме затрат на хостинг нуж­но еще учитывать время на разработку и администрирование. Хотя, конечно,
  сейчас все это не так уж и дорого и, как вариант «в случае чего», я вполне рассматриваю переезд на ненавороченный VPS/VDS, причем
  именно в текущем виде, со статической генерацией, мне достаточно будет са­мо­го-пре­са­мо­го дешевого.

При всем при этом мне *не* нужна логика на бэкенде, динамически формируемые страницы, вот это всё. Даже комментарии, в об­щем-то,
вторичны. Таким образом, все пути ведут к *генераторам статических страниц*.

Почему именно Jekyll?

: Ключевое его преимущество — интеграция с GitHub Pages. То есть схема работы не «сгенерировал страницы из рабочей копии репозитория
  и отправил на сервер», а «написал, закоммитил, запушил» — публикация происходит автоматически при фиксации изменений, исходники
  в репозитории и сайт всегда синхронизированы, то есть не возникает ситуация, когда в репозиторий закоммитил, а опубликовать забыл,
  или, что еще хуже — опубликовал, не закоммитил, и в истории изменений реально работающая версия не попала. Аналогичным образом можно
  организовать публикацию и через **[GitLab][gitlab]{:.img-icon-gitlab}** (там, впрочем, вариантов побольше, но первичный расчет все же
  на GitHub, поскольку я им давно активно пользуюсь). На собственном хостинге эти фазы будут разделены, но во-пер­вых, см. выше про первичный
  расчет, а во-вто­рых, можно и там такое организовать через [хуки Git][git-hooks].

  Второй важный аспект — это то, что Jekyll является [свободным ПО][fs-wiki], [его код открыт][jekyll-code] и опубликован
  под [ли­цен­зи­ей MIT][jekyll-mit]. Что, впрочем, характерно и для многих его аналогов с точностью до конкретной лицензии...

  Менее существенно, но субъективно тоже приятно, что Jekyll написан на **[Ruby][ruby-lang]{:.img-icon-ruby}** — одном из моих любимых языков.
  Что означает реальную, а не гипотетическую возможность воспользоваться преимуществами open source с моей стороны. Реализую ли я ее —
  это отдельный  вопрос, однако мое знакомство с пакетной инфраструктурой Ruby — плагины Jekyll распространяются именно как гемы — явно мне
  помогло в его установке и настройке.

  Что же касается недостатков и подводных камней, далее будет еще много подробностей...

Почему именно Staticman?

: Для начала отмечу, что требования к системе комментариев у меня самые минимальные. И не могу сказать, чтобы я уделил этому вопросу
  много времени. Собственно, *ключевым* преимуществом Staticman стало простое развертывание на бесплатном аккаунте Heroku вкупе
  с возможностью также быстро и просто «в случае чего» развернуть его и на своем сервере (в наличии docker-образ).

  Кроме того:

  * Комментарии хранятся в том же репозитории, что и сайт. Можно и в другом, факт в том, что это будет а) git-ре­по­зи­то­рий, б) под моим управлением.

  * Прикручивается защита от спама. Есть два варианта: re­CAPT­CHA и A­kis­met, и со вторым я пока не разбирался, надеюсь, руки еще дойдут.
    О недостатках и проблемах рекапчи мне известно.

  * Визуальное отображение не просто кастомизируется, а вообще полностью находится в зоне ответственности владельца сайта.

  * [Исходники открыты][staticman-code], под лицензией MIT.

  Из недостатков стоит отметить:

  * Привязка к GitHub/GitLab. Это касается, конечно, не хостинга (Pages), а репозитория — Staticman для добавления комментариев использует
    API этих сервисов, а не пуши Git. Если и там, и там забанят, придется искать другой сервис комментариев. Впрочем, для своего хостинга
    их полно, да и собственный пишется на коленке легко и просто. А уже имеющиеся комментарии никуда не денутся — они в репозитории.

  * Нет авторизации. Кто угодно может писать под каким угодно именем.

  * Уведомления сделаны через Mailgun, который бесплатных тарифных планов не имеет (есть триальный, но это ж временно). Я не стал подключать.
    Вместо этого я в новой версии сайта добавил отображение последних (глобально) трех комментариев в [отдельной панели](#sidebar) на всех страницах.

  В целом, вопрос идеальной системы комментариев остается открытым...

-----

1. p внутри figure (решение — markdown="0"!!!) + figcaption с markdown="span"

2. неочевидный приоритет (специфичность) селекторов

3. не забываем про viewport

4. убрал рекламу

5. про печать comment-actions

6. Длинные урлы в сносках :(

7. Ограничение грида — нельзя дополнительную вложенность. Непонятно как сделать общие рамки с гапами.

8. max-width: 100% для main и box-sizing

9. неинтерполяция в assign и параметрах include

1. Печать пре (переносы)

1. display: block для ифрейма + разрешения для ютуба

1. отсутствие name у элементов коллекций

1. verse (white-space)

2. topper

3. wotermark и невозможность нумерации

1. Довольно трешовое неотрываение иконки, а также бэкграунд вместо контента и прочий геморрой

1. Иконки darktable и Luminance HDR не читаются браузерами (svg)

1. small категории



[jekyll]: https://jekyllrb.com/ "Официальный сайт Jekyll"
[pages]: https://pages.github.com/ "GitHub Pages"
[staticman]: https://staticman.net/ "Официальный сайт Staticman"
[heroku]: https://www.heroku.com/ "Heroku"
[bs]: https://bs.shikhalev.org/ "Мой старый технобложик"
[livejournal]: https://www.livejournal.com/ "Живой Журнал — LiveJournal"
[blogger]: https://www.blogger.com/ "Блог-платформа от Google"
[wordpress]: https://www.wordpress.com/ "WordPress"
[dreamwidth]: https://www.dreamwidth.org/ "DreamWidth — форк LiveJournal"
[markdown]: https://ru.wikipedia.org/wiki/Markdown "Markdown — облегчённый язык разметки"
[git-hooks]: https://git-scm.com/book/ru/v2/Настройка-Git-Хуки-в-Git "Настройка Git - Хуки в Git"
[fs-wiki]: https://ru.wikipedia.org/wiki/Свободное_программное_обеспечение "Свободное программное обеспечение"
[jekyll-code]: https://github.com/jekyll/jekyll "Исходники Jekyll на GitHub"
[jekyll-mit]: https://github.com/jekyll/jekyll/blob/master/LICENSE "Лицензия Jekyll"
[ruby-lang]: https://www.ruby-lang.org/ru/ "Язык программирования Ruby"
[staticman-code]: https://github.com/eduardoboucas/staticman "Исходники Staticman на GitHub"
[gitlab]: https://gitlab.com/ "GitLab"
